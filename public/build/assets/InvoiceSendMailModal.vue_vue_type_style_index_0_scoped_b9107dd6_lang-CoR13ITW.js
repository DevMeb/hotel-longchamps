import{A as S,r as h,k as q,b as D,C as b,B as R}from"./app-MOnSz09z.js";import{n as y}from"./utils-mT5RtY73.js";const A=S("dashboard",()=>{const t=h(null),d=h(!1),g=h(null),p=h(new Date().toISOString().slice(0,7)),m=async()=>{try{d.value=!0,g.value=null;const[a,l]=p.value.split("-"),i=await b.get(`/api/dashboard?month=${l}&year=${a}`);t.value=i.data}catch(a){g.value="Erreur lors du chargement des donn√©es.",console.error(a)}finally{d.value=!1}};function I(a,l,i){if(!t.value||!t.value.reservations)return;const r=t.value.reservations.find(_=>_.id===l.reservation_id);!r||!r.invoices||(r.invoices[i]=r.invoices[i].filter(_=>_.id!==a),r.invoices[i].length===0&&delete r.invoices[i],r.invoices[l.status]||(r.invoices[l.status]=[]),r.invoices[l.status].push(l),E(r),F())}function E(a){if(!a)return;const l=Object.values(a.invoices).flat().filter(r=>r.status==="paid").reduce((r,_)=>r+_.amount,0),i=a.expected_amount;a.actual_amount=l,a.difference=i-l}function F(){if(!t.value)return;let a=0,l=0,i=0;t.value.reservations.forEach(r=>{a+=r.actual_amount,l+=r.expected_amount,i+=r.difference}),t.value.total_actual_amount=a,t.value.total_expected_amount=l,t.value.total_difference=i}q(p,m,{immediate:!0});const w=D(()=>{var a;return((a=t.value)==null?void 0:a.total_reservations)||0}),x=D(()=>{var a;return((((a=t.value)==null?void 0:a.total_actual_amount)||0)/100).toFixed(2)}),v=D(()=>{var a;return((((a=t.value)==null?void 0:a.total_expected_amount)||0)/100).toFixed(2)}),$=D(()=>{var a;return((((a=t.value)==null?void 0:a.total_difference)||0)/100).toFixed(2)});return{dashboardData:t,loading:d,error:g,selectedMonth:p,fetchDashboardData:m,totalReservations:w,totalFactured:x,totalDifference:$,totalExpected:v,updateInvoiceInDashboard:I}}),Y=S("invoices",()=>{const t=h([]),d=h({}),g=h({}),p=A(),m=R("invoice-filters",{renter:"",room:"",status:"",month_year:""});function I(e){m.value=e}const E=D(()=>Object.values(m.value).some(e=>e!=="")),F=h([]);q([t,m],()=>{F.value=t.value.filter(e=>{const{renter:n,room:s,status:o,month_year:u}=m.value;if(n&&e.reservation.renter.id!==parseInt(n)||s&&e.reservation.room.id!==parseInt(s)||o&&e.status!==o)return!1;if(u){const c=new Date(u),f=new Date(e.billing_start_date),j=e.billing_end_date?new Date(e.billing_end_date):null;if((f.getMonth()!==c.getMonth()||f.getFullYear()!==c.getFullYear())&&(!j||j.getMonth()!==c.getMonth()||j.getFullYear()!==c.getFullYear()))return!1}return!0})},{deep:!0,immediate:!0});function w(e){e?d.value[e]=null:d.value={}}function x(e,n){g.value[e]=n}async function v({operation:e,request:n,onSuccess:s}){var o,u,c;w(e),x(e,!0);try{const f=await n();return s&&s(f),f}catch(f){((o=f.response)==null?void 0:o.status)===422?d.value.validationErrors=f.response.data.errors:(d.value[e]=((c=(u=f.response)==null?void 0:u.data)==null?void 0:c.message)||"Une erreur est survenue.",y("error",d.value[e])),console.error(f)}finally{x(e,!1)}}async function $(){return v({operation:"fetch",request:()=>b.get("/api/invoices"),onSuccess:e=>{t.value=e.data.data}})}async function a(e){return v({operation:"add",request:()=>b.post("/api/invoices",e),onSuccess:n=>{t.value.push(n.data.data),y("success",n.data.message)}})}async function l(e){return v({operation:"update",request:()=>b.put(`/api/invoices/${e.id}`,e),onSuccess:n=>{const s=t.value.findIndex(o=>o.id===e.id);s!==-1&&(t.value[s]=n.data.data),y("success",n.data.message)}})}async function i(e){return v({operation:"delete",request:()=>b.delete(`/api/invoices/${e}`),onSuccess:n=>{t.value=t.value.filter(s=>s.id!==e),y("success",n.data.message)}})}const r=new Map;async function _(e){if(r.has(e))return r.get(e);try{const n=await v({operation:"pdf",request:()=>b.get(`/api/invoices/${e}/pdf`,{responseType:"blob"})});if(!n||!n.data)throw new Error("R√©ponse invalide lors de la r√©cup√©ration du PDF.");const s=URL.createObjectURL(new Blob([n.data],{type:"application/pdf"}));return r.set(e,s),s}catch(n){throw console.error(`Erreur lors de la r√©cup√©ration du PDF de la facture ${e} :`,n),new Error("Impossible de r√©cup√©rer le PDF.")}}async function M(e,n){return v({operation:"sendEmail",request:()=>b.post(`/api/invoices/${e}/send-email`,{emails:n}),onSuccess:s=>{const o=s.data.data,u=t.value.findIndex(c=>c.id===e);if(u!==-1?t.value[u]=o:console.warn(`‚ö†Ô∏è Facture ${e} non trouv√©e dans le store invoices.`),p.dashboardData&&o.reservation){const c={id:o.id,reservation_id:o.reservation.id,subject:o.subject,amount:parseInt(o.reservation.room.rent.replace(".","")),billing_start_date:o.billing_start_date,billing_end_date:o.billing_end_date,status:o.status};console.log("üîÑ Mise √† jour de la facture dans le dashboard",c),p.updateInvoiceInDashboard(e,c,"pending")}else console.warn(`‚ö†Ô∏è Impossible de mettre √† jour la facture ${e} dans le dashboard.`);y("success","Facture envoy√©e avec succ√®s.")}})}async function P(e){return v({operation:"paid",request:()=>b.patch(`/api/invoices/${e.id}/paid`),onSuccess:n=>{const s=n.data.data,o=t.value.findIndex(u=>u.id===e.id);if(o!==-1?t.value[o]=s:console.warn(`‚ö†Ô∏è Facture ${e.id} non trouv√©e dans le store invoices.`),p.dashboardData&&s.reservation){const u={id:s.id,reservation_id:s.reservation.id,subject:s.subject,amount:parseInt(s.reservation.room.rent.replace(".","")),billing_start_date:s.billing_start_date,billing_end_date:s.billing_end_date,status:s.status};console.log("üîÑ Mise √† jour de la facture dans le dashboard",u),p.updateInvoiceInDashboard(e.id,u,e.status)}else console.warn(`‚ö†Ô∏è Impossible de mettre √† jour la facture ${e.id} dans le dashboard.`);y("success","Facture marqu√©e comme pay√©e.")}})}return{invoices:t,errors:d,loading:g,fetchInvoices:$,addInvoice:a,updateInvoice:l,deleteInvoice:i,getInvoicePdf:_,sendEmail:M,invoicePaid:P,clearErrors:w,activeFilters:m,updateFilters:I,filteredInvoices:F,isAnyFilterActive:E}});export{Y as a,A as u};
